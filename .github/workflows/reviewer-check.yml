name: Reviewer Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-reviewers:
    runs-on: ubuntu-latest
    steps:
      - name: Check Reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const reviewers = pr.requested_reviewers || [];
            const teamReviewers = pr.requested_teams || [];
            const totalReviewers = reviewers.length + teamReviewers.length;
            const prAuthor = pr.user.login;
            const currentUser = context.actor;
            
            console.log(`ğŸ“‹ Reviewers: ${totalReviewers}`);
            console.log(`ğŸ‘¤ Individual reviewers: ${reviewers.map(r => r.login).join(', ')}`);
            console.log(`ğŸ‘¥ Team reviewers: ${teamReviewers.map(t => t.slug).join(', ')}`);
            console.log(`ğŸ‘¨â€ğŸ’» PR Author: ${prAuthor}`);
            console.log(`ğŸ‘¤ Current User: ${currentUser}`);
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®å‡¦ç†
            if (totalReviewers === 0) {
              // ä¸€æ™‚çš„ã«ä½œæˆè€…è‡ªèº«ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
              if (prAuthor === currentUser) {
                console.log('âœ… Skipping reviewer check for PR author (temporary setting)');
                
                const comment = `
                ## â„¹ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸€æ™‚çš„ï¼‰
                
                **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: #${context.issue.number}
                
                ### ğŸ“ èª¬æ˜
                ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆè€…è‡ªèº«ã®ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚
                
                ### âš ï¸ æ³¨æ„
                - **ä¸€æ™‚çš„ãªè¨­å®š**: ç¾åœ¨ã¯ä½œæˆè€…è‡ªèº«ã®å ´åˆã‚‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã¾ã™
                - æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¿…ãšä»–ã®ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
                - ã“ã®è¨­å®šã¯å¾Œã§å…ƒã«æˆ»ã™äºˆå®šã§ã™ï¼ˆã‚¤ã‚·ãƒ¥ãƒ¼ #5ï¼‰
                
                ---
                ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                
                return;
              }
              
              console.log('âŒ No reviewers assigned');
              
              const comment = `
              ## âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼æœªæŒ‡å®š
              
              **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: #${context.issue.number}
              
              ### âŒ å•é¡Œ
              ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
              
              ### âœ… è§£æ±ºæ–¹æ³•
              1. ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å³å´ã®ã€ŒReviewersã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‚’è¿½åŠ 
              2. ã¾ãŸã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã§ \`@username\` ã‚’æŒ‡å®š
              
              ### ğŸ“‹ æ¨å¥¨ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼
              - é©åˆ‡ãªãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼
              - ã¾ãŸã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è€…
              - **ä¸€æ™‚çš„ã«**: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆè€…è‡ªèº«ã‚‚æŒ‡å®šå¯èƒ½
              
              ### âš ï¸ é‡è¦
              - **ä¸€æ™‚çš„ãªè¨­å®š**: ç¾åœ¨ã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆè€…è‡ªèº«ã‚‚ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã¨ã—ã¦æŒ‡å®šå¯èƒ½ã§ã™
              - ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†è€…ã«é€£çµ¡ã—ã¦ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„
              
              ---
              ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              core.setFailed('âŒ No reviewers assigned. Please assign at least one reviewer to proceed.');
              return;
            } else {
              console.log('âœ… Reviewers are assigned');
              
              // æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
              const reviewerList = reviewers.map(r => `@${r.login}`).join(', ');
              const teamList = teamReviewers.map(t => `@${t.slug}`).join(', ');
              
              const comment = `
              ## âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ç¢ºèªå®Œäº†
              
              **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: #${context.issue.number}
              
              ### ğŸ‘¥ æŒ‡å®šã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼
              ${reviewerList} ${teamList}
              
              ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
              1. ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã‹ã‚‰ã®æ‰¿èªã‚’å¾…æ©Ÿ
              2. æ‰¿èªå¾Œã€ãƒãƒ¼ã‚¸ãŒå¯èƒ½ã«ãªã‚Šã¾ã™
              
              ---
              ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } 